<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ARマーカー表示（地面表示補正つき）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <!-- A-Frame / AR.js -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>
  <!-- マーカーをカメラに向ける用コンポーネント -->
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

  <style>
    html, body { margin:0; overflow:hidden; }
    a-scene { width:100vw; height:100vh; }
  </style>
</head>
<body>

  <!-- ARシーン -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <!-- GPSカメラ -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- マーカーを入れる親ノード -->
    <a-entity id="sceneRoot"></a-entity>
  </a-scene>

  <!-- 地面に接するマーカーを配置する処理 -->
  <script>
    /**
     * GeoJSONファイルを読み込んで、地面に見えるようにマーカーを配置
     */
    async function addGroundMarkers() {
      try {
        const res = await fetch('line_to_points.geojson');
        const geojson = await res.json();
        const root = document.getElementById('sceneRoot');

        geojson.features.forEach(f => {
          if (f.geometry.type !== 'Point') return;
          const [lon, lat] = f.geometry.coordinates;

          // wrapper: GPS座標で位置を決定
          const wrapper = document.createElement('a-entity');
          wrapper.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon}`);

          // marker: 小さな球体、地面に固定、ユーザー方向を向く
          const marker = document.createElement('a-sphere');
          marker.setAttribute('color', 'blue');
          marker.setAttribute('radius', '0.5');
          marker.setAttribute('scale', '0.5 0.5 0.5');
          marker.setAttribute('position', '0 -1.5 0'); // 地面補正
          marker.setAttribute('look-at', '[gps-camera]');

          // optional: 地面プレーン（影のような視覚補助）
          const ground = document.createElement('a-plane');
          ground.setAttribute('width', '2');
          ground.setAttribute('height', '2');
          ground.setAttribute('rotation', '-90 0 0');
          ground.setAttribute('position', '0 -1.6 0');
          ground.setAttribute('color', '#555');
          ground.setAttribute('opacity', '0.2');

          // DOM構成
          wrapper.appendChild(marker);
          wrapper.appendChild(ground);
          root.appendChild(wrapper);
        });

      } catch (err) {
        console.error('マーカー読み込み失敗:', err);
      }
    }

    // 初回 GPS 位置取得後にマーカー表示
    document.querySelector('a-camera').addEventListener('gps-camera-update-position', () => {
      addGroundMarkers();
    }, { once: true });
  </script>
</body>
</html>
