<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>WebXR + Three.js AR補正</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Three.js と WebXR ボタン -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/webxr/ARButton.js"></script>

  <style>
    /* ミニマップ用iframeスタイル */
    #miniFrame {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 150px;
      height: 150px;
      border: none;
      z-index: 10001;
    }
    html, body { margin:0; overflow:hidden; }
    a-scene    { height:100vh; width:100vw; }

    /* 再読み込みボタン */
    #reloadBtn {
      position: fixed; top:10px; right:10px; z-index:10000;
      padding:8px 12px; background:rgba(0,0,0,0.6);
      color:#fff; border:none; border-radius:4px; font-size:14px;
    }

    /* トースト表示 */
    #toast {
      position: fixed; top:10px; left:50%;
      transform: translateX(-50%);
      background:rgba(0,0,0,0.7); color:#fff;
      padding:6px 12px; border-radius:4px;
      display:none; z-index:10002; font-size:14px;
    }

    /* 確認ダイアログ */
    #confirmUI {
      position: fixed; top:50%; left:50%;
      transform: translate(-50%,-50%);
      background:rgba(0,0,0,0.8); color:#fff;
      padding:16px; border-radius:8px;
      display:none; z-index:10003; text-align:center;
    }
    #confirmUI button {
      margin:8px; padding:6px 12px;
      font-size:14px; border:none; border-radius:4px;
    }
    #confirmYes { background:#28a745; color:#fff; }
    #confirmNo  { background:#dc3545; color:#fff; }
  </style>
</head>

<body>
  <!-- ミニマップ埋め込み -->
  <iframe id="miniFrame" src="miniMap.html"></iframe>

  <div id="toast"></div>
  <button id="reloadBtn">再読み込み</button>
  <div id="confirmUI">
    <p>キャリブレーションを実行しますか？</p>
    <button id="confirmYes">はい</button>
    <button id="confirmNo">いいえ</button>
  </div>

  <!-- AR.js / A-Frame シーン -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: true;">
    <a-camera gps-camera rotation-reader></a-camera>
    <a-entity id="sceneRoot"></a-entity>
  </a-scene>

  <script>
    // トースト表示ヘルパー
    function showToast(msg, dur=2000){
      const t=document.getElementById('toast');
      t.innerText=msg; t.style.display='block';
      clearTimeout(t._hideTimeout);
      t._hideTimeout=setTimeout(()=>t.style.display='none',dur);
    }

    // GPS初期取得後にマーカー配置
    async function placeMarkers(){
      const root = document.getElementById('sceneRoot');
      document.querySelectorAll('.calib').forEach(el=>el.remove());
      try {
        const res = await fetch('line_to_points.geojson').then(r=>r.json());
        res.features.forEach(f=>{
          if(f.geometry.type==='Point'){
            const [lon,lat]=f.geometry.coordinates;
            const m=document.createElement('a-sphere');
            m.classList.add('calib');
            m.setAttribute('data-lat',lat);
            m.setAttribute('data-lon',lon);
            m.setAttribute('gps-projected-entity-place',`latitude:${lat};longitude:${lon}`);
            m.setAttribute('radius','0.5');
            m.setAttribute('color','blue');
            root.appendChild(m);
          }
        });
      } catch(e){ console.error('GeoJSON読み込み失敗',e); }
    }
    document.querySelector('a-camera')
      .addEventListener('gps-camera-update-position', placeMarkers, {once:true});

    // タップでキャリブレーション
    (function(){
      const canvas = document.querySelector('canvas');
      const camEl  = document.querySelector('a-camera');
      const root3D = document.getElementById('sceneRoot').object3D;
      const ray    = new THREE.Raycaster();
      const mouse  = new THREE.Vector2();
      let pendingEl = null;

      canvas.addEventListener('click', evt=>{
        mouse.x = (evt.clientX/window.innerWidth)*2 -1;
        mouse.y = - (evt.clientY/window.innerHeight)*2 +1;
        const cam3 = camEl.getObject3D('camera');
        ray.setFromCamera(mouse, cam3);
        const meshes = Array.from(document.querySelectorAll('.calib'))
          .map(el=>el.getObject3D('mesh')).filter(m=>m);
        const hits = ray.intersectObjects(meshes, true);
        if(!hits.length){ showToast('マーカーをタップしてください'); return; }
        pendingEl = hits[0].object.el;
        document.getElementById('confirmUI').style.display='block';
      });

      document.getElementById('confirmYes').onclick = ()=>{
        document.getElementById('confirmUI').style.display='none';
        if(!pendingEl) return;
        const markerPos = new THREE.Vector3();
        pendingEl.object3D.getWorldPosition(markerPos);
        const camPos = new THREE.Vector3();
        camEl.object3D.getWorldPosition(camPos);
        const offset = new THREE.Vector3().subVectors(markerPos, camPos);
        root3D.position.sub(offset);
        document.querySelectorAll('.calib').forEach(el=>{
          el.removeAttribute('gps-projected-entity-place');
        });
        showToast('キャリブレーション完了');
        pendingEl = null;
      };

      document.getElementById('confirmNo').onclick = ()=>{
        document.getElementById('confirmUI').style.display='none';
        pendingEl = null;
        showToast('キャンセルしました');
      };
    })();

    // 再読み込み機能
    document.getElementById('reloadBtn').onclick = ()=>{
      showToast('再読み込み中…'); location.reload();
    };

    // 大幅移動検出で自動リロード
    let initLat=null, initLon=null, TH=100;
    function hav(a,b,c,d){
      const R=6371000, r=Math.PI/180;
      const d1=(c-a)*r, d2=(d-b)*r;
      const A=Math.sin(d1/2)**2 +Math.cos(a*r)*Math.cos(c*r)*Math.sin(d2/2)**2;
      return 2*R*Math.asin(Math.sqrt(A));
    }
    navigator.geolocation.watchPosition(pos=>{
      const la=pos.coords.latitude, lo=pos.coords.longitude;
      if(initLat===null) { initLat=la; initLon=lo; }
      else if(hav(initLat,initLon,la,lo)>TH){
        showToast('大幅移動を検出、再読み込みします');
        location.reload();
      }
    }, console.error, {enableHighAccuracy:true, maximumAge:1000, timeout:5000});
  </script>
</body>
</html>
