<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>WebXR + Three.js AR補正</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- A-Frame と AR.js -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <style>
    html, body { margin:0; overflow:hidden; }
    a-scene { width:100vw; height:100vh; }

    /* ミニマップ用 iframe */
    #miniFrame {
      position: fixed; bottom:10px; left:10px;
      width:150px; height:150px;
      border:1px solid #ccc; background:#fff;
      z-index:10001; transition:all .2s;
    }
    /* ミニマップ全画面 */
    #miniFrame.fullscreen {
      top:0; left:0; bottom:0;
      width:100vw; height:100vh;
      z-index:20000;
    }
    /* ミニマップ非表示（AR全画面） */
    #miniFrame.hidden { display:none; }

    /* ボタン共通 */
    .btn {
      position: fixed; padding:8px 12px;
      background:rgba(0,0,0,0.6); color:#fff;
      border:none; border-radius:4px; font-size:14px;
      z-index:20001; cursor:pointer;
    }
    #toggleMini { bottom: 170px; left: 10px; }
    #toggleAR   { bottom: 130px; left: 10px; }
    #reloadBtn  { top: 10px; right: 10px; }

    /* トースト */
    #toast {
      position: fixed; top:50px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.7); color:#fff;
      padding:6px 12px; border-radius:4px;
      display:none; z-index:20002; font-size:14px;
    }
    /* キャリブレーションダイアログ */
    #confirmUI { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.8); color:#fff; padding:16px; border-radius:8px;
      display:none; z-index:20003; text-align:center; }
    #confirmUI button { margin:8px; padding:6px 12px; font-size:14px; border:none; border-radius:4px; }
    #confirmYes { background:#28a745; }
    #confirmNo  { background:#dc3545; }
  </style>
</head>
<body>
  <!-- ミニマップ -->
  <iframe id="miniFrame" src="miniMap.html"></iframe>
  <!-- 操作ボタン -->
  <button id="toggleMini" class="btn">Mini全画面</button>
  <button id="toggleAR" class="btn">AR全画面</button>
  <button id="reloadBtn" class="btn">再読み込み</button>
  <div id="toast"></div>
  <div id="confirmUI">
    <p>キャリブレーションを実行しますか？</p>
    <button id="confirmYes">はい</button>
    <button id="confirmNo">いいえ</button>
  </div>

  <!-- ARシーン -->
  <a-scene embedded arjs="sourceType:webcam;debugUIEnabled:false;gpsCameraMinDistance:0;gpsCameraMaxDistance:1000;">
    <a-camera gps-camera rotation-reader></a-camera>
    <a-entity id="sceneRoot"></a-entity>
  </a-scene>

  <script>
    // トースト表示
    function showToast(msg, dur=2000){
      const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block';
      clearTimeout(t._hideTimeout); t._hideTimeout=setTimeout(()=>t.style.display='none',dur);
    }

    // マーカー配置
    async function placeMarkers(){
      const root=document.getElementById('sceneRoot');
      document.querySelectorAll('.calib').forEach(el=>el.remove());
      try{
        const res=await fetch('line_to_points.geojson').then(r=>r.json());
        res.features.forEach(f=>{
          if(f.geometry.type==='Point'){
            const [lon,lat]=f.geometry.coordinates;
            const m=document.createElement('a-sphere');
            m.classList.add('calib');
            m.setAttribute('gps-entity-place',`latitude:${lat};longitude:${lon}`);
            m.setAttribute('radius','1'); m.setAttribute('color','red');
            root.appendChild(m);
          }
        });
      }catch(e){ console.error(e); }
    }
    document.querySelector('a-camera').addEventListener('gps-camera-update-position',placeMarkers,{once:true});

    // キャリブレーション
    (function(){
      const canvas=document.querySelector('canvas');
      const camEl=document.querySelector('a-camera');
      const root3D=document.getElementById('sceneRoot').object3D;
      const ray=new THREE.Raycaster(); const mouse=new THREE.Vector2(); let pending=null;

      canvas.addEventListener('click',e=>{
        mouse.x=(e.clientX/window.innerWidth)*2-1;
        mouse.y=-(e.clientY/window.innerHeight)*2+1;
        ray.setFromCamera(mouse,camEl.getObject3D('camera'));
        const objs=Array.from(document.querySelectorAll('.calib')).map(el=>el.getObject3D('mesh')).filter(m=>m);
        const hits=ray.intersectObjects(objs);
        if(!hits.length){ showToast('マーカーをタップしてください'); return; }
        pending=hits[0].object.el; document.getElementById('confirmUI').style.display='block';
      });
      document.getElementById('confirmYes').onclick=()=>{
        document.getElementById('confirmUI').style.display='none'; if(!pending) return;
        const pos=new THREE.Vector3(); pending.object3D.getWorldPosition(pos);
        const camPos=new THREE.Vector3(); document.querySelector('a-camera').object3D.getWorldPosition(camPos);
        root3D.position.subVectors(pos,camPos); document.querySelectorAll('.calib').forEach(el=>el.removeAttribute('gps-entity-place'));
        showToast('キャリブレーション完了'); pending=null;
      };
      document.getElementById('confirmNo').onclick=()=>{ document.getElementById('confirmUI').style.display='none'; pending=null; showToast('キャンセルしました'); };
    })();

    // 再読み込み
    document.getElementById('reloadBtn').onclick=()=>{ showToast('再読み込み中…'); location.reload(); };

    // トグルボタン
    document.getElementById('toggleMini').onclick=()=>{
      const fm=document.getElementById('miniFrame'); fm.classList.toggle('fullscreen');
    };
    document.getElementById('toggleAR').onclick=()=>{
      const fm=document.getElementById('miniFrame'); fm.classList.toggle('hidden');
    };
  </script>
</body>
</html>
